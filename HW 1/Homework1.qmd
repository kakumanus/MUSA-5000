---
title: "Homework 1: Using OLS Regression to Predict Median House Values in Philadelphia"
author: "Yiming Cao, Sujan Kakumanu, Angel Sanaa Rutherford"
date: October 15 2025
number-sections: true
format: pdf
---
```{r setup}
#| echo: false
#| results: "hide" # Hide the output
#| message: false  # Hide messages
#| warning: false  # Hide warnings
#| fig.show: "hide" # Hide plots/figures
options(scipen = 999)
library(ggplot2)             
library(dplyr)
library(sf)
library(ggplot2)
library(patchwork)
library(MASS)
library(caret)
```

```{r exploratory-data-analysis}
#| echo: false
#| results: "hide" # Hide the output
#| message: false  # Hide messages
#| warning: false  # Hide warnings
#| fig.show: "hide" # Hide plots/figures
regression_data <- read.csv("./RegressionData.csv")

hist(regression_data$MEDHVAL)
hist(regression_data$PCTBACHMOR)
hist(regression_data$NBELPOV100)
hist(regression_data$PCTVACANT)
hist(regression_data$PCTSINGLES)

plot(regression_data$PCTBACHMOR, regression_data$MEDHVAL)
plot(regression_data$NBELPOV100, regression_data$MEDHVAL)
plot(regression_data$PCTVACANT, regression_data$MEDHVAL)
plot(regression_data$PCTSINGLES, regression_data$MEDHVAL)

mean_medhval <- mean(regression_data$MEDHVAL)
mean_pctbachmor <- mean(regression_data$PCTBACHMOR)
mean_nbelpov100 <- mean(regression_data$NBELPOV100)
mean_pctvacant <- mean(regression_data$PCTVACANT)
mean_pctsingles <- mean(regression_data$PCTSINGLES)

sd_medhval <- sd(regression_data$MEDHVAL)
sd_pctbachmor <- sd(regression_data$PCTBACHMOR)
sd_nbelpov100 <- sd(regression_data$NBELPOV100)
sd_pctvacant <- sd(regression_data$PCTVACANT)
sd_pctsingles <- sd(regression_data$PCTSINGLES)
```

```{r exploratory-data-analysis-log}
#| echo: false
#| results: "hide" # Hide the output
#| message: false  # Hide messages
#| warning: false  # Hide warnings
#| fig.show: "hide" # Hide plots/figures
regression_data$LNMEDHVAL<-log(regression_data$MEDHVAL)

regression_data$LNPCTBACHMOR<-log(1+regression_data$PCTBACHMOR)
regression_data$LNNBELPOV100<-log(1+regression_data$NBELPOV100)
regression_data$LNPCTVACANT<-log(1+regression_data$PCTVACANT)
regression_data$LNPCTSINGLES<-log(1+regression_data$PCTSINGLES)

hist(regression_data$LNMEDHVAL)
hist(regression_data$LNPCTBACHMOR)
hist(regression_data$LNNBELPOV100)
hist(regression_data$LNPCTVACANT)
hist(regression_data$LNPCTSINGLES)

plot(regression_data$PCTBACHMOR, regression_data$LNMEDHVAL)
plot(regression_data$LNNBELPOV100, regression_data$LNMEDHVAL)
plot(regression_data$PCTVACANT, regression_data$LNMEDHVAL)
plot(regression_data$PCTSINGLES, regression_data$LNMEDHVAL)

cor(regression_data$PCTBACHMOR, regression_data$LNMEDHVAL, method="pearson")
cor(regression_data$LNNBELPOV100, regression_data$LNMEDHVAL, method="pearson")
cor(regression_data$PCTVACANT, regression_data$LNMEDHVAL, method="pearson")
cor(regression_data$PCTSINGLES, regression_data$LNMEDHVAL, method="pearson")

trimmed_regression_data <- regression_data %>% dplyr::select(PCTBACHMOR, LNNBELPOV100, PCTVACANT, LNMEDHVAL, PCTSINGLES)
#remove LNMEDHVAL in final product
cor(trimmed_regression_data)
```

```{r exploratory-data-analysis-mapping}
#| echo: false
#| results: "hide" # Hide the output
#| message: false  # Hide messages
#| warning: false  # Hide warnings
#| fig.show: "hide" # Hide plots/figures
Regression_shpData <- st_read("./Lecture 1 - RegressionData.shp")

ggplot(Regression_shpData) +
  geom_sf(aes(fill =  LNMEDHVAL), color = NA) +
  scale_fill_viridis_c(option = "plasma")+
  labs(
    title = "Log Transformed Median House Value by Census Block Groups",
    subtitle = "Philadelphia"
  ) +
  theme_minimal()

base_theme <- theme_minimal() +
  theme(
    axis.text = element_blank(),
    axis.title = element_blank(),
    panel.grid = element_blank(),
    plot.title = element_text(size = 6, margin = margin(b = 4))  # smaller + some breathing room
  )

p1 <- ggplot(Regression_shpData) +
  geom_sf(aes(fill = PCTVACANT), color = NA) +
  scale_fill_viridis_c(option = "plasma", na.value = "grey80") +
  labs(title = "Percent of Housing Units that are Vacant,\n at Block Group", fill = "Value") +
  theme_minimal() +
  theme(axis.text = element_blank(), axis.title = element_blank(), panel.grid = element_blank()) +
  base_theme

p2 <- ggplot(Regression_shpData) +
  geom_sf(aes(fill = PCTSINGLES), color = NA) +
  scale_fill_viridis_c(option = "plasma", na.value = "grey80") +
  labs(title = "Percent of Housing Units that are Single Family Detatched,\n at Block Group", fill = "Value") +
  theme_minimal() +
  theme(axis.text = element_blank(), axis.title = element_blank(), panel.grid = element_blank()) +
  base_theme

p3 <- ggplot(Regression_shpData) +
  geom_sf(aes(fill = PCTBACHMOR), color = NA) +
  scale_fill_viridis_c(option = "plasma", na.value = "grey80") +
  labs(title = "Percent of Housing Units that have at least Bachelor's Degree,\n at Block Group", fill = "Value") +
  theme_minimal() +
  theme(axis.text = element_blank(), axis.title = element_blank(), panel.grid = element_blank()) +
  base_theme

p4 <- ggplot(Regression_shpData) +
  geom_sf(aes(fill = LNNBELPOV), color = NA) +
  scale_fill_viridis_c(option = "plasma", na.value = "grey80") +
  labs(title = "Log Transformed Number of Households Below 100% Poverty Level,\n at Block Group", fill = "Value") +
  theme_minimal() +
  theme(axis.text = element_blank(), axis.title = element_blank(), panel.grid = element_blank()) +
  base_theme

(p1 | p2) / (p3 | p4)
```

```{r multiple-regression-analysis}
#| echo: false
#| results: "hide" # Hide the output
#| message: false  # Hide messages
#| warning: false  # Hide warnings
#| fig.show: "hide" # Hide plots/figures
#| 
reg1 <- lm(LNMEDHVAL ~ PCTVACANT + PCTSINGLES + PCTBACHMOR + LNNBELPOV, data=Regression_shpData)

summary(reg1)

anova(reg1)

Regression_shpData$predvals <- fitted(reg1) 

Regression_shpData$resids <- residuals(reg1)

Regression_shpData$stdres <- rstandard(reg1)

plot(Regression_shpData$predvals, Regression_shpData$stdres)

```

```{r step}
#| echo: false
#| results: "hide" # Hide the output
#| message: false  # Hide messages
#| warning: false  # Hide warnings
#| fig.show: "hide" # Hide plots/figures
step <- stepAIC(reg1, direction="both")

step$anova
```

```{r k-fold-cv}
#| echo: false
#| results: "hide" # Hide the output
#| message: false  # Hide messages
#| warning: false  # Hide warnings
#| fig.show: "hide" # Hide plots/figures
train_control <- trainControl(method = "cv", number = 5)

cv_model <- train(LNMEDHVAL ~ PCTVACANT + PCTSINGLES + PCTBACHMOR + LNNBELPOV,
                  data = Regression_shpData,
                  method = "lm",
                  trControl = train_control)
cv_model

cv_model_2 <- train(LNMEDHVAL ~ PCTVACANT + MEDHHINC,
                  data = Regression_shpData,
                  method = "lm",
                  trControl = train_control)
cv_model_2
```

```{r std-residuals-charts}
#| echo: false
#| results: "hide" # Hide the output
#| message: false  # Hide messages
#| warning: false  # Hide warnings
#| fig.show: "hide" # Hide plots/figures
hist(Regression_shpData$stdres)

ggplot(Regression_shpData) +
  geom_sf(aes(fill =  stdres), color = NA) +
  scale_fill_viridis_c(option = "plasma")+
  labs(
    title = "",
    subtitle = ""
  ) +
  theme_minimal()
```

# Introduction

  In this analysis, we use a multiple linear regression model to predict median house values in Philadelphia. Drawing on Philadelphiaâ€™s tract-level census data, we examine the impact of our four predictors on our response variable median house value: percentage with at least a bachelorâ€™s degree, percentage of vacant spaces, number living below the poverty line, and percentage of single family housing units.

  Prior theoretical knowledge of the relationships between housing markets and socioeconomic factors has led us to hypothesize a relationship between these four predictors and median house value. High rates of educational attainment and single-family homes are likely positively associated with house values as they may indicate neighborhood stability by signaling higher earning potential and long-term residency. Conversely, high rates of vacancy and poverty levels are likely negatively associated with house values as they may indicate neighborhood instability through a lack of high earning residents and occupants overall. In this analysis, we aim to assess the explanatory power of these predictors and briefly explore if these relationships possess any spatial patterns. 

# Methods

## Data Cleaning

## Exploratory Data Analysis

## Multiple Regression Analysis

## Additional Analysis

###
  Using the stepAIC() and step$anova command, we applied bidirectional stepwise regression to analyze the fit of our linear model. Stepwise regression determines the minimum number of predictors that yield the best model. Stepwise regression automatically selects or eliminates predictors, either forwards, backwards, or bidirectionally, based on some type of criteria that measures the goodness of fit. In this case, we are attempting to determine the predictor or combination of predictors that minimize the Akaike Information Criterion (AIC).
  
  Stepwise regression, however, poses many limitations as it does not consider theoretical relevance of the predictors, may overlook alternative valid models, and runs the risk of excluding important predictors and including unimportant predictors, especially due to the numerous t-tests measuring whether the null hypothesis,  $\beta_k$ = 0, is true.

###
  To perform cross-validation, we used the trainControl() function with the method parameter set to â€œcvâ€ (cross-validation) and the train() function with the method parameter set to â€œlmâ€ (linear model). Cross-validation is a technique that measures model performance unbiasedly by training the model on a select subgroup of observations and seeing how well it estimates deliberately excluded observations. K-fold cross validation where k=5, specifically, divides data sets into five non-overlapping folds and repeatedly uses four folds for training the model and one fold for validating the model so that each fold trains the model multiple times and validates the model once. This method ensures a modelâ€™s generalizability to new data and minimizes distortion by avoiding omitting and duplicating data in its measure of fit.  After all five iterations are complete, the Root Mean Squared Error (RMSE) of the model is returned as a measurement of the average magnitude of predicted residuals or errors between predicted values, $\hat{ð‘¦}_i$, of observation $i$, estimated by the modelâ€™s $\beta$ coefficient, and the actual value, $y_i$, of the validation set. The complete formula for RMSE is as follows: 
$$
RMSE = \sqrt{\frac{1}{n} \sum_{i=1}^{n} (y_i - \hat{y}_i)^2}
$$
After performing k-fold cross-validation on two or more models, the RMSE of the models can be compared to determine which model has the best performance. A smaller RMSE indicates that the modelâ€™s predictions are, on average, closer to the actual values, and thus more representative of the data.

## Software Used

###
  All data analysis was conducted using R. Within R, the following packages were used to perform data preparation, exploratory analysis, regression modeling, and visualization: ggplot, dplyr, sf, patchwork, MASS, and caret. 
 
# Results

## Exploratory Results

## Regression Results

## Regression Assumption Checks

### 
  In this section, we assess whether our multiple regression model meets key assumptions and take the necessary steps to address any violations of these assumptions. Early visualizations of the distribution of the predictors PCTBACHMOR, NBELOWPOV100, PCTVACANT, and PCTSINGLES and the dependent variable MEDHVAL were presented by histograms which all showed positively-skewed distributions for all predictors. While multiple regression assumptions require the normality of residuals and not predictor values, non-normal distribution of predictors values can indicate violations of the assumptions of non-normal residuals and a lack of linearity.

### 
```{r ii. predictor scatter plots, fig.width=8, fig.height=6}
#| echo: false

     p5 <- ggplot(data = regression_data, aes(x =PCTBACHMOR, y = MEDHVAL)) +
     geom_point(shape=1)+
        labs(
        title = "Median House Value by\n Percentage with Bachelors",
        x= "Percentage with Bachelors",
        y= "Median House Value"
        )+
       theme_minimal()+
       theme(
       panel.grid = element_blank(),
       plot.title = element_text(face = "bold"))
     
     p6 <- ggplot(data = regression_data, aes(x =NBELPOV100, y = MEDHVAL)) +
      geom_point(shape=1)+
        labs(
        title = "Median House Value by\n Number Below Poverty",
        x= "Number Below Poverty",
        y= "Median House Value"
        )+
       theme_minimal()+
       theme(
       panel.grid = element_blank(),
       plot.title = element_text(face = "bold"))
     
     p7 <- ggplot(data = regression_data, aes(x =PCTVACANT, y = MEDHVAL)) +
      geom_point(shape=1)+
        labs(
        title = "Median House Value by\n Percentage of Vacant Units",
        x= "Percentage Vacant",
        y= "Median House Value"
        )+
       theme_minimal()+
       theme(
        panel.grid = element_blank(),  
       plot.title = element_text(face = "bold"))

     p8 <- ggplot(data = regression_data, aes(x =PCTSINGLES, y = MEDHVAL)) +
      geom_point(shape=1)+
        labs(
        title = "Median House Value by\n Percentage of Single Units",
        x= "Percentage of Singles",
        y= "Median House Value"
        )+
       theme_minimal()+
       theme(
       panel.grid = element_blank(),
       plot.title = element_text(face = "bold"))
 
(p5 |p6 ) / (p7| p8)
```

  The skewedness of histograms of each predictor is reflected in the scatter plots of the predictors by the dependent variable median house value, MEDHVAL, as, as the predictor values increase, y values cluster towards lower values. The lack of linearity between the predictor and MEDHVAL and the skewed distribution of predictor values suggest that some type of nonlinear transformation may need to occur in order to normally distribute values and achieve linearity. We performed log transformations which are commonly used to correct the positively skewed distributions evident in our variables.

### 
```{r iii. std residuals histogram}
#| echo: false
hist(Regression_shpData$stdres,
     main = "Histogram of Standardized Regression Residuals",
     xlab = "Standardized Residuals",
     ylab = "Frequency")
```
  We applied logarithmic transformations to all predictors and the dependent variable to see whether the transformations would improve distribution of their values and subsequently allow us to assume linearity and residual normality. We only substituted the log-transformed MEDHVAL (LNMEDHVAL) and log-transformed NBELOPOV (LNNBELOPOV) for the rest of our analysis. The log-transformed predictors PCTVACANT, PCTSINGLES, and PCTBACHMOR did not return an improvement and instead produced zero-inflated distributions. We proceeded to calculate our standardized residuals with the new model of original predictors PCTVACANT, PCTSINGLES, and PCTBACHMOR and with our log-transformed predictor LNNBELPOV by our log transformed dependent variable LNMEDHVAL. The histogram of the standardized residuals show the normality in residuals needed per our assumption and support the need for the logarithmic transformations.

###  
```{r iv. std residual scatter plot}
#| echo: false
plot(Regression_shpData$predvals, Regression_shpData$stdres,
     main = "Standardized Residuals By Predicted Values",
     xlab = "Predicted Values",
     ylab = "Standardized Residuals")
```
  Standardized residuals are residuals divided by their standard deviation as a means to prime residuals across different observations for comparison through normalization. The scatter plot of our standardized residuals shows general homoscedasticity or consistent variance of residuals. There is general uniformity of the standardized residuals as most lie between -2 and positive 2. There are some outliers that extend past -4 and 4 but they do not dominate the overall pattern. There is also no funneling affect or any other pattern of non-constant variance. Thus, our model satisfies the assumption of homoscedasticity of residuals.

###
  Initial spatial visualizations of the dependent and predictor variables suggest that there may be some spatial autocorrelation between their respective measurements. The choropleth map of the logged dependent variable LNMEDHVAL shows that lower values seem to be concentrated in parts of North, Southwest, and West Philadelphia while higher values were clustered in Upper North Philadelphia. The choropleth map of the predictor PCTSINGLES shows higher percentages in parts of Upper North and Northeast Philadelphia. The choropleth map of the predictor PCTBACHMOR shows higher percentages in parts of Upper North and Center Philadelphia. The choropleth map of the logged predictor LNNBELPOV showed lower values in parts of  Upper North, Northeast, and Center Philadelphia. The choropleth map of the predictor PCTVACANT shows higher percentages in parts of North, West, Southwest, South, and Center Philadelphia.This visual inspection suggests that block groups might not be entirely independent of each other and could require further spatial assessment.

### 
```{r vi. std residual choropleth, fig.width=8, fig.height=6}
#| echo: false
ggplot(Regression_shpData) +
  geom_sf(aes(fill =  stdres), color = NA) +
  scale_fill_viridis_c(option = "plasma", name = "Standardized\nResiduals")+
  labs(
    title = "Map of Standardized Regression Residuals"
  ) +
  theme_void()+
  theme(
    plot.title = element_text(face = "bold", size=16, hjust = 0.7))


```
  The choropleth of standardized residuals suggests possible spatial autocorrelation as there seems to be a concentration of lower values in the southern half of Philadelphia. Visually, there seems to be a gradient effect stemming outward from North Philadelphia into West, Southwest, and South Philadelphia. This indicates that their could be additional factors producing systematic under prediction in the southern half of Philadelphia, especially in North Philadelphia. 

## Additional Models

###
**Stepwise Regression ANOVA table**
```{r i. stepwise results}
#| echo: false
step <- stepAIC(reg1, direction="both")

step$anova

```


  Our initial model before performing stepwise regression:
$$
\text{LNMEDHVAL} \sim \text{PCTVACANT} + \text{PCTSINGLES} + \text{PCTBACHMOR} + \text{LNNBELPOV}
$$
As mentioned earlier, stepwise regression based on AIC evaluates whether a predictor improves the model fit by reducing the AIC. Our initial model had an AIC of -3448.162. When PCTSINGLES was removed, the AIC increased to â€“3432.3. When LNNBELPOV was removed, the AIC increased to â€“3365.0. When PCTVACANT was removed, the AIC increased to  â€“3102.8. When our last predictor PCTBACHMOR was removed, the AIC increased drastically to â€“2379.0. Since the removal of each predictor resulted in a higher AIC, all four initial predictors were retained in the final model. This suggests that the initial model was selected by stepwise regression as being a model that balances explanatory power and complexity.

###
**K-fold Cross-validation Table**
```{r ii. cross-validation}
#| echo: false
train_control <- trainControl(method = "cv", number = 5)

cv_model <- train(LNMEDHVAL ~ PCTVACANT + PCTSINGLES + PCTBACHMOR + LNNBELPOV,
                  data = Regression_shpData,
                  method = "lm",
                  trControl = train_control)
cv_model

cv_model_2 <- train(LNMEDHVAL ~ PCTVACANT + MEDHHINC,
                  data = Regression_shpData,
                  method = "lm",
                  trControl = train_control)
cv_model_2
```


  We performed 5 fold cross-validation on two models, the first model including all of our original predictors and the second model being a reduced set of predictors that alternatively included MEDHHINC as a predictor. The second model is as follows:

$$
\text{LNMEDHVAL} \sim \text{PCTVACANT} + \text{MEDHHINC}
$$ 

The original model yielded a RMSE of 0.368 while the reduced model yielded a RMSE of 0.443, signaling that the additional predictors in the full model had better predictive power compared to  PCTVACANT and MEDHHINC alone. 

# Discussion & Limitations

